<!doctype html>
<html>
	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<script src="{{ url_for('static', filename='js/mui.min.js') }}"></script>
		<link href="{{ url_for('static', filename='css/mui.min.css') }}" rel="stylesheet"/>
		<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/iconfont.css') }}"/>
		<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/style.css') }}"/>
		<style>
			#add{
				height: 8px;
				width: 8px;
			}
			#img{
				width: 100px;
				overflow: hidden;
				padding-top: 10px;
			}	
			#img span{
				display: block;
				float: left;
			}
			#img div{
				float:left;
				margin-right: 10px;
				position: relative;
			}
			#img img{
				height:50px;
				widows: 50px;;
			}
			#img i{
				background: red;
				color:#fff;
				border-radius: 50%;
				width: 15px;
				text-align: center;
				height: 15px;
				line-height: 15px;
				position: absolute;
				top:-5px;
				right:-5px;
				font-size: 10px;
			}
		</style>
	</head>
	<body>
		<header class="mui-bar mui-bar-nav bgcolor">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
		    <h1 class="mui-title">添加吃过的食物</h1>
		</header>
		<div class="mui-content">
		    <div class="fa-box">
		    	<input type="text" class="info" placeholder="吃的啥？">
		    	<textarea cols="60" class="info" rows="10" style="height:100px;" placeholder="请输入你的评论"></textarea>
				<div class="mui-input-row mui-input-range">
					<label>评分</label>
					<input type="range" min="0" max="5">
				</div>
				<div class="mui-input-row mui-input-range">
					<label>酸</label>
					<input type="range" min="0" max="5">
				</div>
				<div class="mui-input-row mui-input-range">
					<label>甜</label>
					<input type="range" min="0" max="5">
				</div>
				<div class="mui-input-row mui-input-range">
					<label>辣</label>
					<input type="range" min="0" max="5">
				</div>
				<div class="mui-input-row mui-input-range">
					<label>咸</label>
					<input type="range" min="0" max="5">
				</div>
				<div class="mui-input-row mui-input-range">
					<label>腻</label>
					<input type="range" min="0" max="5">
				</div>
				<div style="height:40px;"></div>
		    	<div id="img">
		    		<div style="width:50px;height:50px;"><span id="add">+</span></div>
		    		<!--<div>
			    			<img src="img/logo1.png" alt="" />
			    			<i class="del">+</i>
			    		</div>-->
		    	</div>
		    </div>
		    <div class="btn">
		    	<button id="btn">发布</button>
		    </div>
		</div>
		<script type="text/javascript">
			mui.init();
			var img = document.getElementById('img');
			
			c_event();
			function c_event(){
				var add = document.getElementById('add');
				add.addEventListener('tap',function(){
					
					
					mui.plusReady(function(){
						var btnArray = [{title:"照相机"},{title:"相册"}]; //选择按钮  1 2 3
						plus.nativeUI.actionSheet( {
							title:"请选择",
							cancel:"取消", // 0
							buttons:btnArray
							}, 
							function(e){
								var index = e.index; // 
								
								if(index == 1){
									var cmr = plus.camera.getCamera();
									cmr.captureImage( function ( p ) {
											//成功
											plus.io.resolveLocalFileSystemURL( p, function ( entry ) {
										
	//										    var img_name = entry.name;//获得图片名称
	//										    var img_path = entry.toLocalURL();//获得图片路径
												updata_img(entry.toLocalURL());
											}, function ( e ) {
												console.log( "读取拍照文件错误："+e.message );
											} );
											
										}, function ( e ) {
											console.log( "失败："+e.message );
									}, {filename:'_doc/camera/',index:1} ); //  “_doc/camera/“  为保存文件名
								}else {
									plus.gallery.pick( function(path){
	   
									    updata_img(path);
									}, function ( e ) {
									    console.log( "取消选择图片" );
									}, {filter:"image"} );
								}
								
						} );
											
						
						
					});
					
					
					
				});
			}
			
			
			function updata_img(p){
				//初始上传地址  
				var server="http://peipao.dongyixueyuan.com/upload_file.php";  // 学员测试使用
				var files=[]; //图片存放的数组 可以上传一个，或者多个图片 
						
						
	
					//又初始化了一下文件数组 为了支持我的单个上传,如果你要一次上传多个，就不要在写这一行了
					//注意 
					files=[];
					var n=p.substr(p.lastIndexOf('/')+1);
					files.push({name:"uploadkey",path:p});
					
	
						
				
					if(files.length<=0){
						plus.nativeUI.alert("没有添加上传文件！");
						return;
					}
					//原生的转圈等待框
					var wt=plus.nativeUI.showWaiting();
							
					var task=plus.uploader.createUpload(server,
						{method:"POST"},
						function(t,status){ //上传完成
				
							if(status==200){
										
								//资源
								var responseText = t.responseText;
										
								//转换成json
								var json = eval('(' + responseText + ')');
									
								//上传文件的信息
								var files = json.files;
								
								//上传成功以后的保存路径
								var img_url = files.uploadkey.url;
										
//								alert(img_url);
										
								//ajax 写入数据库
								create_image(img_url);		
										
										
								//关闭转圈等待框
								wt.close();
							}else{
								console.log("上传失败："+status);
								//关闭原生的转圈等待框
								wt.close();
							}
						});
							
					task.addData("client","");
					task.addData("uid",getUid());
					for(var i=0;i<files.length;i++){
						var f=files[i];
						task.addFile(f.path,{key:f.name});
					}
					task.start();
						
				
					
				
			}
			
			// 产生一个随机数
			function getUid(){
				return Math.floor(Math.random()*100000000+10000000).toString();
			}
			
			
			
			///插入图片
			function create_image(path){
				var url = 'http://peipao.dongyixueyuan.com' +path;
				var tmpl = '<div>'
				    		+'	<img src="'+url+'" alt="" />'
				    		+'	<i class="del">+</i>'
				    		+'</div>';
				img.innerHTML += tmpl;
				c_event();
				
				del_event();
							
			}
			
			//删除图片
			function del_event(){
				var del_cell = document.getElementsByClassName('del');
				for(var a=0;a<del_cell.length;a++){
					del_cell[a].addEventListener('tap',function(){
						
						img.removeChild(this.parentNode);
						
						
					});
				}
	
			};
			
			
			//发布帖子
			var btn = document.getElementById('btn');
			var info = document.getElementsByClassName('info');
			btn.addEventListener('tap',function(){
				
				var title = info[0].value;
				var content = info[1].value;
				if(title == ''){
					mui.toast('标题不为空');
					return;
				}
				
				var img_arr = img.getElementsByTagName('img');
				var img_data = [];
				for(var a=0;a<img_arr.length;a++){
					img_data.push(img_arr[a].src);
				}
				
				if(img_data){
					img_data = img_data.join('-');
				}
				
				
				var request_url = localStorage.getItem('request_url');
				var phone = localStorage.getItem('login_phone');
				
				mui.get(
					request_url+'Groups/add_topic',
					{
						title:title,
						content:content,
						img:img_data,
						phone:phone
					},
					function(data){
						
						if(data > 0){
							mui.toast('发送成功');
							
							//通知
							mui.plusReady(function(){
								
								var a = plus.webview.getWebviewById('a.html');
								mui.fire(a,'update_topic',{});
								
								mui.back();
								
							});
							
							
							
							
						}else{
							mui.toast('发送失败');
						}
						
						
					},
					'json'
				);
				
				
				
				
				
			})
			
			
		</script>
	</body>
</html>